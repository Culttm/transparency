<!DOCTYPE html>  <html> <head>   <title>transparency.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               transparency.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p><strong>Transparency</strong> is a client-side template engine which binds JSON objects to DOM elements.</p>

<pre><code>//  Template:
//
//  &lt;ul id="todos"&gt;
//    &lt;li class="todo"&gt;&lt;/li&gt;
//  &lt;/ul&gt;

template = document.querySelector('#todos');

models = [
  {todo: "Eat"},
  {todo: "Do some programming"},
  {todo: "Sleep"}
];

Transparency.render(template, models);

//  Result:
//  &lt;ul id="todos"&gt;
//    &lt;li class="todo"&gt;Eat&lt;/li&gt;
//    &lt;li class="todo"&gt;Do some programming&lt;/li&gt;
//    &lt;li class="todo"&gt;Sleep&lt;/li&gt;
//   &lt;/ul&gt;
</code></pre>

<p>This documentation focuses on the implementation and internals.
For the full API reference, please see the README.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h2>Public API</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Transparency = </span><span class="vi">@Transparency = </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p><code>Transparency.render</code> maps JSON objects to DOM elements.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Transparency.render = </span><span class="nf">(context, models = [], directives = {}, options = {}) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>First, check if we are in debug mode and if so, log the arguments.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">log = </span><span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">debug</span> <span class="o">and</span> <span class="nx">console</span> <span class="k">then</span> <span class="nx">consoleLogger</span> <span class="k">else</span> <span class="nx">nullLogger</span>
  <span class="nx">log</span> <span class="s">&quot;Transparency.render:&quot;</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">models</span><span class="p">,</span> <span class="nx">directives</span><span class="p">,</span> <span class="nx">options</span>

  <span class="k">return</span> <span class="k">unless</span> <span class="nx">context</span>
  <span class="nv">models = </span><span class="p">[</span><span class="nx">models</span><span class="p">]</span> <span class="k">unless</span> <span class="nx">isArray</span> <span class="nx">models</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Context element, state and functionality is wrapped to <code>Context</code> object. Get it, or create a new
if it doesn't exist yet.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">context = </span><span class="nx">data</span><span class="p">(</span><span class="nx">context</span><span class="p">).</span><span class="nx">context</span> <span class="o">||=</span> <span class="k">new</span> <span class="nx">Context</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Rendering is a lot faster when the context element is detached from the DOM, as
reflow calculations are not triggered. So, detach it before rendering.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">context</span>
    <span class="p">.</span><span class="nx">detach</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">models</span><span class="p">,</span> <span class="nx">directives</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attach</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <h3>Configuration</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>In order to use Transparency as a jQuery plugin, add Transparency.jQueryPlugin to jQuery.fn object.</p>

<pre><code>$.fn.render = Transparency.jQueryPlugin;

// Render with jQuery
$('#template').render({hello: 'World'});
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Transparency.jQueryPlugin = </span><span class="nf">(models, directives, options) -&gt;</span>
  <span class="k">for</span> <span class="nx">context</span> <span class="k">in</span> <span class="k">this</span>
    <span class="nx">Transparency</span><span class="p">.</span><span class="nx">render</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">models</span><span class="p">,</span> <span class="nx">directives</span><span class="p">,</span> <span class="nx">options</span>
  <span class="k">this</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>By default, Transparency matches model properties to elements by <code>id</code>, <code>class</code>, <code>name</code> and <code>data-bind</code> attributes.
Override <code>Transparency.matcher</code> to change the default behavior.</p>

<pre><code>// Match only by `data-bind` attribute
Transparency.matcher = function (element, key) {
  element.getAttribute('data-bind') == key;
};
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Transparency.matcher = </span><span class="nf">(element, key) -&gt;</span>
  <span class="nx">element</span><span class="p">.</span><span class="nx">id</span>                        <span class="o">==</span> <span class="nx">key</span>        <span class="o">||</span>
  <span class="nx">indexOf</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">className</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">),</span> <span class="nx">key</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span>
  <span class="nx">element</span><span class="p">.</span><span class="nx">name</span>                      <span class="o">==</span> <span class="nx">key</span>        <span class="o">||</span>
  <span class="nx">element</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s">&#39;data-bind&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="nx">key</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>IE6-8 fails to clone nodes properly. By default, Transparency uses jQuery.clone() as a shim.
Override <code>Transparency.clone</code> with a custom clone function, if oldIE needs to be
supported without jQuery.</p>

<pre><code>Transparency.clone = myCloneFunction;
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Transparency.clone = </span><span class="nf">(node) -&gt;</span> <span class="p">(</span><span class="nx">jQuery</span> <span class="o">||</span> <span class="nx">Zepto</span><span class="p">)</span><span class="o">?</span><span class="p">(</span><span class="nx">node</span><span class="p">).</span><span class="nx">clone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <h2>Internals</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Chainable method decorator (example in node.js console).</p>

<blockquote>
  <p>o       = {}
  o.hello = "Hello"
  o.foo   = chainable(function(){console.log(this.hello + " World")});
  o.foo().hello
     Hello World
     "Hello"</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">chainable = </span><span class="nf">(method) -&gt;</span> <span class="nf">-&gt;</span> <span class="nx">method</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span> <span class="k">this</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p><strong>Context</strong> stores the original <code>template</code> elements and is responsible for creating,
adding and removing template <code>instances</code> to match the amount of <code>models</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Context</span>
  <span class="nv">constructor: </span><span class="nf">(@el) -&gt;</span>
    <span class="vi">@template      = </span><span class="nx">cloneNode</span> <span class="nx">@el</span>
    <span class="vi">@instances     = </span><span class="p">[</span><span class="k">new</span> <span class="nx">Instance</span><span class="p">(</span><span class="nx">@el</span><span class="p">)]</span>
    <span class="vi">@instanceCache = </span><span class="p">[]</span>

  <span class="nv">detach: </span><span class="nx">chainable</span> <span class="nf">-&gt;</span>
    <span class="vi">@parent = </span><span class="nx">@el</span><span class="p">.</span><span class="nx">parentNode</span>
    <span class="k">if</span> <span class="nx">@parent</span>
      <span class="vi">@nextSibling = </span><span class="nx">@el</span><span class="p">.</span><span class="nx">nextSibling</span>
      <span class="nx">@parent</span><span class="p">.</span><span class="nx">removeChild</span> <span class="nx">@el</span>

  <span class="nv">attach: </span><span class="nx">chainable</span> <span class="nf">-&gt;</span>
    <span class="k">if</span> <span class="nx">@parent</span>
      <span class="k">if</span> <span class="nx">@nextSibling</span>
      <span class="k">then</span> <span class="nx">@parent</span><span class="p">.</span><span class="nx">insertBefore</span> <span class="nx">@el</span><span class="p">,</span> <span class="nx">@nextSibling</span>
      <span class="k">else</span> <span class="nx">@parent</span><span class="p">.</span><span class="nx">appendChild</span> <span class="nx">@el</span>

  <span class="nv">render: </span><span class="nx">chainable</span> <span class="nf">(models, directives, options) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Cloning DOM elements is expensive, so save unused template <code>instances</code> and reuse them later.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">while</span> <span class="nx">models</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">@instances</span><span class="p">.</span><span class="nx">length</span>
      <span class="nx">@instanceCache</span><span class="p">.</span><span class="nx">push</span> <span class="nx">@instances</span><span class="p">.</span><span class="nx">pop</span><span class="p">().</span><span class="nx">remove</span><span class="p">()</span>

    <span class="k">for</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">index</span> <span class="k">in</span> <span class="nx">models</span>
      <span class="k">unless</span> <span class="nv">instance = </span><span class="nx">@instances</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span>
        <span class="nv">instance = </span><span class="nx">@instanceCache</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span> <span class="o">||</span> <span class="k">new</span> <span class="nx">Instance</span><span class="p">(</span><span class="nx">cloneNode</span><span class="p">(</span><span class="nx">@template</span><span class="p">))</span>
        <span class="nx">@instances</span><span class="p">.</span><span class="nx">push</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">appendTo</span><span class="p">(</span><span class="nx">@el</span><span class="p">)</span>

      <span class="nx">instance</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">directives</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Template <strong>Instance</strong> is created for each model we are about to render.
<code>instance</code> object keeps track of template DOM nodes and elements.
It memoizes the matching elements to <code>queryCache</code> in order to speed up the rendering.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Instance</span>
  <span class="nv">constructor: </span><span class="nf">(template) -&gt;</span>
    <span class="vi">@queryCache = </span><span class="p">{}</span>
    <span class="vi">@childNodes = </span><span class="nx">getChildNodes</span> <span class="nx">template</span>
    <span class="vi">@elements   = </span><span class="nx">getElements</span>   <span class="nx">template</span>

  <span class="nv">remove: </span><span class="nx">chainable</span> <span class="nf">-&gt;</span>
    <span class="k">for</span> <span class="nx">node</span> <span class="k">in</span> <span class="nx">@childNodes</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">removeChild</span> <span class="nx">node</span>

  <span class="nv">appendTo: </span><span class="nx">chainable</span> <span class="nf">(parent) -&gt;</span>
    <span class="k">for</span> <span class="nx">node</span> <span class="k">in</span> <span class="nx">@childNodes</span>
      <span class="nx">parent</span><span class="p">.</span><span class="nx">appendChild</span> <span class="nx">node</span>

  <span class="nv">render: </span><span class="nx">chainable</span> <span class="nf">(model, index, directives, options) -&gt;</span>
    <span class="nv">children = </span><span class="p">[]</span>

    <span class="nx">@reset</span><span class="p">(</span><span class="nx">model</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">renderValues</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">children</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">renderDirectives</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">directives</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">renderChildren</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">children</span><span class="p">,</span> <span class="nx">directives</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>

  <span class="nv">reset: </span><span class="nx">chainable</span> <span class="nf">(model) -&gt;</span>
    <span class="k">for</span> <span class="nx">element</span> <span class="k">in</span> <span class="nx">@elements</span>
      <span class="nx">element</span><span class="p">.</span><span class="nx">reset</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>A bit of offtopic, but let's think about writing event handlers.
It would be convenient to have an access to the associated <code>model</code>
when the user clicks a todo element without setting <code>data-id</code> attributes or other
identifiers manually. So be it.</p>

<pre><code>$('#todos').on('click', '.todo', function(e) {
  console.log(e.target.transparency.model);
});
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">data</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nv">model = </span><span class="nx">model</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Rendering values takes care of the most common use cases like
rendering text content, form values and DOM elements (.e.g., Backbone Views).
Rendering as a text content is a safe default, as it is HTML escaped
by the browsers.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">renderValues: </span><span class="nx">chainable</span> <span class="nf">(model, children) -&gt;</span>
    <span class="k">if</span> <span class="nx">isDomElement</span><span class="p">(</span><span class="nx">model</span><span class="p">)</span> <span class="o">and</span> <span class="nv">element = </span><span class="nx">@elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="nx">element</span><span class="p">.</span><span class="nx">empty</span><span class="p">().</span><span class="nx">el</span><span class="p">.</span><span class="nx">appendChild</span> <span class="nx">model</span>

    <span class="k">else</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">model</span> <span class="o">==</span> <span class="s">&#39;object&#39;</span>
      <span class="k">for</span> <span class="k">own</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">model</span> <span class="k">when</span> <span class="nx">value</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>The value can be either a nested model or a plain value, i.e., <code>Date</code>, <code>string</code>, <code>boolean</code> or <code>double</code>.
Start by handling the plain values and finding the matching elements.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">isPlainValue</span> <span class="nx">value</span>
          <span class="k">for</span> <span class="nx">element</span> <span class="k">in</span> <span class="nx">@matchingElements</span> <span class="nx">key</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Element type also affects on rendering. Given a model</p>

<pre><code>{todo: 'Do some OSS', type: 2}
</code></pre>

<p><code>div</code> element should have <code>textContent</code> set,
<code>input</code> element should have <code>value</code> attribute set and
with <code>select</code> element, the matching <code>option</code> element should set to <code>selected="selected"</code>.</p>

<pre><code>  &lt;div id="template"&gt;
    &lt;div class="todo"&gt;Do some OSS&lt;/todo&gt;
     &lt;input name="todo" value="Do some OSS" /&gt;
     &lt;select name="type"&gt;
       &lt;option value="1"&gt;Work&lt;/option&gt;
       &lt;option value="2" selected="selected"&gt;Hobby&lt;/option&gt;
     &lt;/select&gt;
  &lt;/div&gt;
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nv">nodeName = </span><span class="nx">element</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span>
            <span class="k">if</span> <span class="nx">nodeName</span> <span class="o">==</span> <span class="s">&#39;input&#39;</span>
              <span class="nx">element</span><span class="p">.</span><span class="nx">attr</span> <span class="s">&#39;value&#39;</span><span class="p">,</span> <span class="nx">value</span>
            <span class="k">else</span> <span class="k">if</span> <span class="nx">nodeName</span> <span class="o">==</span> <span class="s">&#39;select&#39;</span>
              <span class="nx">element</span><span class="p">.</span><span class="nx">attr</span> <span class="s">&#39;selected&#39;</span><span class="p">,</span> <span class="nx">value</span>
            <span class="k">else</span> <span class="nx">element</span><span class="p">.</span><span class="nx">attr</span> <span class="s">&#39;text&#39;</span><span class="p">,</span>  <span class="nx">value</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Rendering nested models breadth-first is more robust, as there might be colliding keys,
i.e., given a model</p>

<pre><code>{
  name: "Jack",
  friends: [
    {name: "Matt"},
    {name: "Carol"}
  ]
}
</code></pre>

<p>and a template</p>

<pre><code>&lt;div id="person"&gt;
  &lt;div class="name"&gt;&lt;/div&gt;
  &lt;div class="friends"&gt;
    &lt;div class="name"&gt;&lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;
</code></pre>

<p>the depth-first rendering might give us wrong results, if the children are rendered
before the <code>name</code> field on the parent model (child template values are overwritten by the parent).</p>

<pre><code>&lt;div id="person"&gt;
  &lt;div class="name"&gt;Jack&lt;/div&gt;
  &lt;div class="friends"&gt;
    &lt;div class="name"&gt;Jack&lt;/div&gt;
    &lt;div class="name"&gt;Jack&lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;
</code></pre>

<p>Save the key of the child model and take care of it once
we're done with the parent model.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">else</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">value</span> <span class="o">==</span> <span class="s">&#39;object&#39;</span>
          <span class="nx">children</span><span class="p">.</span><span class="nx">push</span> <span class="nx">key</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>With <code>directives</code>, user can give explicit rules for rendering and set
attributes, which would be potentially unsafe by default (e.g., unescaped HTML content or <code>src</code> attribute).
Given a template</p>

<pre><code>&lt;div class="template"&gt;
  &lt;div class="escaped"&gt;&lt;/div&gt;
  &lt;div class="unescaped"&gt;&lt;/div&gt;
  &lt;img class="trusted" src="#" /&gt;
&lt;/div&gt;
</code></pre>

<p>and a model and directives</p>

<pre><code>model = {
  content: "&lt;script&gt;alert('Injected')&lt;/script&gt;"
  url: "http://trusted.com/funny.gif"
};

directives = {
  escaped: { text: { function() { return this.content } } },
  unescaped: { html: { function() { return this.content } } },
  trusted: { url: { function() { return this.url } } }
}

$('#template').render(model, directives);
</code></pre>

<p>should give the result</p>

<pre><code>&lt;div class="template"&gt;
  &lt;div class="escaped"&gt;&amp;lt;script&amp;gt;alert('Injected')&amp;lt;/script&amp;gt;&lt;/div&gt;
  &lt;div class="unescaped"&gt;&lt;script&gt;alert('Injected')&lt;/script&gt;&lt;/div&gt;
  &lt;img class="trusted" src="http://trusted.com/funny.gif" /&gt;
&lt;/div&gt;
</code></pre>

<p>Directives are executed after the default rendering, so that they can be used for overriding default rendering.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">renderDirectives: </span><span class="nx">chainable</span> <span class="nf">(model, index, directives) -&gt;</span>
    <span class="k">return</span> <span class="k">this</span> <span class="k">unless</span> <span class="nx">directives</span>
    <span class="nv">model = </span><span class="k">if</span> <span class="k">typeof</span> <span class="nx">model</span> <span class="o">==</span> <span class="s">&#39;object&#39;</span> <span class="k">then</span> <span class="nx">model</span> <span class="k">else</span> <span class="nv">value: </span><span class="nx">model</span>

    <span class="k">for</span> <span class="k">own</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">attributes</span> <span class="k">of</span> <span class="nx">directives</span> <span class="k">when</span> <span class="k">typeof</span> <span class="nx">attributes</span> <span class="o">==</span> <span class="s">&#39;object&#39;</span>
      <span class="k">for</span> <span class="nx">element</span> <span class="k">in</span> <span class="nx">@matchingElements</span> <span class="nx">key</span>
        <span class="k">for</span> <span class="nx">attribute</span><span class="p">,</span> <span class="nx">directive</span> <span class="k">of</span> <span class="nx">attributes</span> <span class="k">when</span> <span class="k">typeof</span> <span class="nx">directive</span> <span class="o">==</span> <span class="s">&#39;function&#39;</span>

          <span class="nv">value = </span><span class="nx">directive</span><span class="p">.</span><span class="nx">call</span> <span class="nx">model</span><span class="p">,</span>
            <span class="nv">element: </span><span class="nx">element</span><span class="p">.</span><span class="nx">el</span>
            <span class="nv">index: </span>  <span class="nx">index</span>
            <span class="nv">value: </span>  <span class="nx">element</span><span class="p">.</span><span class="nx">originalAttributes</span><span class="p">[</span><span class="nx">attribute</span><span class="p">]</span>

          <span class="nx">element</span><span class="p">.</span><span class="nx">attr</span> <span class="nx">attribute</span><span class="p">,</span> <span class="nx">value</span>

  <span class="nv">renderChildren: </span><span class="nx">chainable</span> <span class="nf">(model, children, directives, options) -&gt;</span>
    <span class="k">for</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">children</span>
      <span class="k">for</span> <span class="nx">element</span> <span class="k">in</span> <span class="nx">@matchingElements</span> <span class="nx">key</span>
        <span class="nx">Transparency</span><span class="p">.</span><span class="nx">render</span> <span class="nx">element</span><span class="p">.</span><span class="nx">el</span><span class="p">,</span> <span class="nx">model</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span> <span class="nx">directives</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span> <span class="nx">options</span>

  <span class="nv">matchingElements: </span><span class="nf">(key) -&gt;</span>
    <span class="nv">elements = </span><span class="nx">@queryCache</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">||=</span> <span class="p">(</span><span class="nx">e</span> <span class="k">for</span> <span class="nx">e</span> <span class="k">in</span> <span class="nx">@elements</span> <span class="k">when</span> <span class="nx">Transparency</span><span class="p">.</span><span class="nx">matcher</span> <span class="nx">e</span><span class="p">.</span><span class="nx">el</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
    <span class="nx">log</span> <span class="s">&quot;Matching elements for &#39;</span><span class="si">#{</span><span class="nx">key</span><span class="si">}</span><span class="s">&#39;:&quot;</span><span class="p">,</span> <span class="nx">elements</span>
    <span class="nx">elements</span>

<span class="nv">getChildNodes = </span><span class="nf">(el) -&gt;</span>
  <span class="nv">childNodes = </span><span class="p">[]</span>
  <span class="nv">child = </span><span class="nx">el</span><span class="p">.</span><span class="nx">firstChild</span>
  <span class="k">while</span> <span class="nx">child</span>
    <span class="nx">childNodes</span><span class="p">.</span><span class="nx">push</span> <span class="nx">child</span>
    <span class="nv">child = </span><span class="nx">child</span><span class="p">.</span><span class="nx">nextSibling</span>
  <span class="nx">childNodes</span>

<span class="nv">getElements  = </span><span class="nf">(el) -&gt;</span>
  <span class="nv">elements = </span><span class="p">[]</span>
  <span class="nx">_getElements</span> <span class="nx">el</span><span class="p">,</span> <span class="nx">elements</span>
  <span class="nx">elements</span>

<span class="nv">_getElements = </span><span class="nf">(template, elements) -&gt;</span>
  <span class="nv">child = </span><span class="nx">template</span><span class="p">.</span><span class="nx">firstChild</span>
  <span class="k">while</span> <span class="nx">child</span>
    <span class="k">if</span> <span class="nx">child</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">==</span> <span class="nx">ELEMENT_NODE</span>
      <span class="nx">elements</span><span class="p">.</span><span class="nx">push</span> <span class="k">new</span> <span class="nx">Element</span><span class="p">(</span><span class="nx">child</span><span class="p">)</span>
      <span class="nx">_getElements</span> <span class="nx">child</span><span class="p">,</span> <span class="nx">elements</span>

    <span class="nv">child = </span><span class="nx">child</span><span class="p">.</span><span class="nx">nextSibling</span>

<span class="k">class</span> <span class="nx">Element</span>
  <span class="nv">constructor: </span><span class="nf">(@el) -&gt;</span>
    <span class="vi">@childNodes         = </span><span class="nx">getChildNodes</span> <span class="nx">@el</span>
    <span class="vi">@nodeName           = </span><span class="nx">@el</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span>
    <span class="vi">@originalAttributes = </span><span class="p">{}</span>

  <span class="nv">empty: </span><span class="nf">-&gt;</span>
    <span class="nx">@el</span><span class="p">.</span><span class="nx">removeChild</span> <span class="nx">child</span> <span class="k">while</span> <span class="nv">child = </span><span class="nx">@el</span><span class="p">.</span><span class="nx">firstChild</span>
    <span class="k">this</span>

  <span class="nv">reset: </span><span class="nf">-&gt;</span>
    <span class="k">for</span> <span class="nx">attribute</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">@originalAttributes</span>
      <span class="nx">@attr</span> <span class="nx">attribute</span><span class="p">,</span> <span class="nx">value</span>

  <span class="nv">setHtml: </span><span class="nf">(html) -&gt;</span>
    <span class="nx">@empty</span><span class="p">()</span>
    <span class="vi">@el.innerHTML = </span><span class="nx">html</span>
    <span class="k">for</span> <span class="nx">child</span> <span class="k">in</span> <span class="nx">@childNodes</span>
      <span class="nx">@el</span><span class="p">.</span><span class="nx">appendChild</span> <span class="nx">child</span>

  <span class="nv">setText: </span><span class="nf">(text) -&gt;</span>
    <span class="nv">textNode = </span><span class="nx">@el</span><span class="p">.</span><span class="nx">firstChild</span>

    <span class="k">if</span> <span class="o">!</span><span class="nx">textNode</span>
      <span class="nx">@el</span><span class="p">.</span><span class="nx">appendChild</span> <span class="nx">@el</span><span class="p">.</span><span class="nx">ownerDocument</span><span class="p">.</span><span class="nx">createTextNode</span> <span class="nx">text</span>

    <span class="k">else</span> <span class="k">if</span> <span class="nx">textNode</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">!=</span> <span class="nx">TEXT_NODE</span>
      <span class="nx">@el</span><span class="p">.</span><span class="nx">insertBefore</span> <span class="nx">@el</span><span class="p">.</span><span class="nx">ownerDocument</span><span class="p">.</span><span class="nx">createTextNode</span><span class="p">(</span><span class="nx">text</span><span class="p">),</span> <span class="nx">textNode</span>

    <span class="k">else</span>
      <span class="nv">textNode.nodeValue = </span><span class="nx">text</span>

  <span class="nv">getText: </span><span class="nf">-&gt;</span>
    <span class="p">(</span><span class="nx">child</span><span class="p">.</span><span class="nx">nodeValue</span> <span class="k">for</span> <span class="nx">child</span> <span class="k">in</span> <span class="nx">@childNodes</span> <span class="k">when</span> <span class="nx">child</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">==</span> <span class="nx">TEXT_NODE</span><span class="p">).</span><span class="nx">join</span> <span class="s">&#39;&#39;</span>

  <span class="nv">setSelected: </span><span class="nf">(value) -&gt;</span>
    <span class="nv">value = </span><span class="nx">value</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
    <span class="nv">childElements = </span><span class="nx">getElements</span> <span class="nx">@el</span>
    <span class="k">for</span> <span class="nx">child</span> <span class="k">in</span> <span class="nx">childElements</span>
      <span class="k">if</span> <span class="nx">child</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;option&#39;</span>
        <span class="k">if</span> <span class="nx">child</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">value</span> <span class="o">==</span> <span class="nx">value</span>
          <span class="nv">child.el.selected = </span><span class="kc">true</span>
        <span class="k">else</span>
          <span class="nv">child.el.selected = </span><span class="kc">false</span>

  <span class="nv">attr: </span><span class="nf">(attribute, value) -&gt;</span>
    <span class="k">return</span> <span class="k">unless</span> <span class="nx">value</span><span class="o">?</span>
    <span class="k">if</span> <span class="nx">@nodeName</span> <span class="o">==</span> <span class="s">&#39;select&#39;</span> <span class="o">and</span> <span class="nx">attribute</span> <span class="o">==</span> <span class="s">&#39;selected&#39;</span>
      <span class="nx">@setSelected</span> <span class="nx">value</span>

    <span class="k">else</span>
      <span class="k">switch</span> <span class="nx">attribute</span>
        <span class="k">when</span> <span class="s">&#39;text&#39;</span>
          <span class="k">unless</span> <span class="nx">isVoidElement</span> <span class="nx">@el</span>
            <span class="nx">@originalAttributes</span><span class="p">[</span><span class="s">&#39;text&#39;</span><span class="p">]</span> <span class="o">?=</span> <span class="nx">@getText</span><span class="p">()</span>
            <span class="nx">@setText</span> <span class="nx">value</span>

        <span class="k">when</span> <span class="s">&#39;html&#39;</span>
          <span class="nx">@originalAttributes</span><span class="p">[</span><span class="s">&#39;html&#39;</span><span class="p">]</span> <span class="o">?=</span> <span class="nx">@el</span><span class="p">.</span><span class="nx">innerHTML</span>
          <span class="nx">@setHtml</span> <span class="nx">value</span>

        <span class="k">when</span> <span class="s">&#39;class&#39;</span>
          <span class="nx">@originalAttributes</span><span class="p">[</span><span class="s">&#39;class&#39;</span><span class="p">]</span> <span class="o">?=</span> <span class="nx">@el</span><span class="p">.</span><span class="nx">className</span>
          <span class="vi">@el.className = </span><span class="nx">value</span>

        <span class="k">else</span>
          <span class="nx">@el</span><span class="p">[</span><span class="nx">attribute</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>
          <span class="k">if</span> <span class="nx">isBoolean</span> <span class="nx">value</span>
            <span class="nx">@originalAttributes</span><span class="p">[</span><span class="nx">attribute</span><span class="p">]</span> <span class="o">?=</span> <span class="nx">@el</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="nx">attribute</span><span class="p">)</span> <span class="o">||</span> <span class="kc">false</span>
            <span class="k">if</span> <span class="nx">value</span>
              <span class="nx">@el</span><span class="p">.</span><span class="nx">setAttribute</span> <span class="nx">attribute</span><span class="p">,</span> <span class="nx">attribute</span>
            <span class="k">else</span>
              <span class="nx">@el</span><span class="p">.</span><span class="nx">removeAttribute</span> <span class="nx">attribute</span>
          <span class="k">else</span>
            <span class="nx">@originalAttributes</span><span class="p">[</span><span class="nx">attribute</span><span class="p">]</span> <span class="o">?=</span> <span class="nx">@el</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="nx">attribute</span><span class="p">)</span> <span class="o">||</span> <span class="s">&quot;&quot;</span>
            <span class="nx">@el</span><span class="p">.</span><span class="nx">setAttribute</span> <span class="nx">attribute</span><span class="p">,</span> <span class="nx">value</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>

<span class="nv">ELEMENT_NODE = </span><span class="mi">1</span>
<span class="nv">TEXT_NODE    = </span><span class="mi">3</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>From http://www.w3.org/TR/html-markup/syntax.html: void elements in HTML</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">VOID_ELEMENTS = </span><span class="p">[</span><span class="s">&quot;area&quot;</span><span class="p">,</span> <span class="s">&quot;base&quot;</span><span class="p">,</span> <span class="s">&quot;br&quot;</span><span class="p">,</span> <span class="s">&quot;col&quot;</span><span class="p">,</span> <span class="s">&quot;command&quot;</span><span class="p">,</span> <span class="s">&quot;embed&quot;</span><span class="p">,</span> <span class="s">&quot;hr&quot;</span><span class="p">,</span> <span class="s">&quot;img&quot;</span><span class="p">,</span> <span class="s">&quot;input&quot;</span><span class="p">,</span> <span class="s">&quot;keygen&quot;</span><span class="p">,</span> <span class="s">&quot;link&quot;</span><span class="p">,</span> <span class="s">&quot;meta&quot;</span><span class="p">,</span> <span class="s">&quot;param&quot;</span><span class="p">,</span> <span class="s">&quot;source&quot;</span><span class="p">,</span> <span class="s">&quot;track&quot;</span><span class="p">,</span> <span class="s">&quot;wbr&quot;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>IE8 &lt;= fails to clone detached nodes properly, shim with jQuery
jQuery.clone: https://github.com/jquery/jquery/blob/master/src/manipulation.js#L594
jQuery.support.html5Clone: https://github.com/jquery/jquery/blob/master/src/support.js#L83</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">html5Clone = </span><span class="p">()</span> <span class="nf">-&gt;</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s">&quot;nav&quot;</span><span class="p">).</span><span class="nx">cloneNode</span><span class="p">(</span><span class="kc">true</span><span class="p">).</span><span class="nx">outerHTML</span> <span class="o">!=</span> <span class="s">&quot;&lt;:nav&gt;&lt;/:nav&gt;&quot;</span>
<span class="nv">cloneNode  =</span>
  <span class="k">if</span> <span class="o">not</span> <span class="nb">document</span><span class="o">?</span> <span class="o">or</span> <span class="nx">html5Clone</span><span class="p">()</span>
    <span class="nf">(node) -&gt;</span> <span class="nx">node</span><span class="p">.</span><span class="nx">cloneNode</span> <span class="kc">true</span>
  <span class="k">else</span>
    <span class="nf">(node) -&gt;</span>
      <span class="nv">cloned = </span><span class="nx">Transparency</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">cloned</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">==</span> <span class="nx">ELEMENT_NODE</span>
        <span class="nx">cloned</span><span class="p">.</span><span class="nx">removeAttribute</span> <span class="nx">expando</span>
        <span class="k">for</span> <span class="nx">element</span> <span class="k">in</span> <span class="nx">cloned</span><span class="p">.</span><span class="nx">getElementsByTagName</span> <span class="s">&#39;*&#39;</span>
          <span class="nx">element</span><span class="p">.</span><span class="nx">removeAttribute</span> <span class="nx">expando</span>
      <span class="nx">cloned</span>

<span class="nv">expando = </span><span class="s">&#39;transparency&#39;</span>
<span class="nv">data    = </span><span class="nf">(element) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Expanding DOM element with a JS object is generally unsafe.
However, as references to expanded DOM elements are never lost, no memory leaks are introduced
http://perfectionkills.com/whats-wrong-with-extending-the-dom/</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">element</span><span class="p">[</span><span class="nx">expando</span><span class="p">]</span> <span class="o">||=</span> <span class="p">{}</span>

<span class="nv">nullLogger    = </span><span class="p">()</span> <span class="nf">-&gt;</span>
<span class="nv">consoleLogger = </span><span class="nf">(messages...) -&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">messages</span><span class="p">...</span>
<span class="nv">log           = </span><span class="nx">nullLogger</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Mostly from https://github.com/documentcloud/underscore/blob/master/underscore.js</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">toString      = </span><span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span>
<span class="nv">isDate        = </span><span class="nf">(obj) -&gt;</span> <span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;[object Date]&#39;</span>
<span class="nv">isDomElement  = </span><span class="nf">(obj) -&gt;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">==</span> <span class="nx">ELEMENT_NODE</span>
<span class="nv">isVoidElement = </span><span class="nf">(el)  -&gt;</span> <span class="nx">indexOf</span><span class="p">(</span><span class="nx">VOID_ELEMENTS</span><span class="p">,</span> <span class="nx">el</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">())</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span>
<span class="nv">isPlainValue  = </span><span class="nf">(obj) -&gt;</span> <span class="nx">isDate</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">or</span> <span class="k">typeof</span> <span class="nx">obj</span> <span class="o">!=</span> <span class="s">&#39;object&#39;</span> <span class="o">and</span> <span class="k">typeof</span> <span class="nx">obj</span> <span class="o">!=</span> <span class="s">&#39;function&#39;</span>
<span class="nv">isBoolean     = </span><span class="nf">(obj) -&gt;</span> <span class="nx">obj</span> <span class="o">is</span> <span class="kc">true</span> <span class="o">or</span> <span class="nx">obj</span> <span class="o">is</span> <span class="kc">false</span>
<span class="nv">isArray       = </span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span> <span class="o">||</span> <span class="nf">(obj) -&gt;</span> <span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;[object Array]&#39;</span>
<span class="nv">indexOf       = </span><span class="nf">(array, item) -&gt;</span>
  <span class="k">return</span> <span class="nx">array</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="k">if</span> <span class="nx">array</span><span class="p">.</span><span class="nx">indexOf</span>
  <span class="k">for</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">array</span>
    <span class="k">if</span> <span class="nx">x</span> <span class="o">==</span> <span class="nx">item</span> <span class="k">then</span> <span class="k">return</span> <span class="nx">i</span>
  <span class="o">-</span><span class="mi">1</span>

<span class="p">(</span><span class="nx">jQuery</span> <span class="o">||</span> <span class="nx">Zepto</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nv">fn.render = </span><span class="nx">Transparency</span><span class="p">.</span><span class="nx">jQueryPlugin</span>

<span class="k">if</span> <span class="nx">define</span><span class="o">?</span><span class="p">.</span><span class="nx">amd</span> <span class="k">then</span> <span class="nx">define</span> <span class="nf">-&gt;</span> <span class="nx">Transparency</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 